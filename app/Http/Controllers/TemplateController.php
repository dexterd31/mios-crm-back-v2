<?php

namespace App\Http\Controllers;

use App\Models\Template;
use Illuminate\Http\Request;
use App\Models\User;
use Helpers\MiosHelper;

class TemplateController extends Controller
{
    private $templateModel;
    private $miosHelper;

    public function __construct()
    {
        $this->middleware('auth');
    }

    public function setTemplateModel($templateModel)
	{
		$this->templateModel = $templateModel;
	}

    public function getTemplateModel()
	{
		if($this->templateModel == null)
		{
			$this->setTemplateModel(new Template());
		}
		return $this->templateModel;
	}

    public function setMiosHelper($miosHelper)
	{
		$this->miosHelper = $miosHelper;
	}

    public function getMiosHelper()
	{
		if($this->miosHelper == null)
		{
			$this->setMiosHelper(new MiosHelper());
		}
		return $this->miosHelper;
	}

    /**
     * João Beleño
     * 02-08-2021
     * Método para crear el template
     */
    public function store(Request $template)
    {
        try {
            $template = new Template([
                "form_id" => $template ->form_id,
                "user_rrhh_id" => $this->authUser()->rrhh_id,
                "template_name" => $template->template_name,
                "input_id" => json_encode($template->input_id),
                "fields_writable" => json_encode($template->fields_writable),
                "state" => 1,
                "value_delimiter" => $template->value_delimiter,
            ]);
            $template->save();
            $miosHelper = $this->getMiosHelper();
            return $miosHelper->jsonResponse(true, 200, 'message', 'Plantilla guardada correctamente');
        } catch (\Throwable $th)
        {
            $miosHelper = $this->getMiosHelper();
            return $miosHelper->jsonResponse(false, 500, 'message', 'Ha ocurrido un error');
        }
    }

    /**
     * João Beleño
     * 02-08-2021
     * Método para listar los nombres de los campos del template
     */
    private function getiInputNames($templates)
    {
        foreach($templates as $template)
        {
            $inputNames = array();
            $inputs = json_decode($template->input_id, true);
            foreach ($inputs as $input)
            {
                array_push($inputNames, $input['label']);
            }
            unset($template->input_id);
            $template->inputNames = $inputNames;
        }
        return $templates;
    }

    /**
     * João Beleño
     * 02-08-2021
     * Metodo para listar los templates
     */
    public function show(Request $request, $formId)
    {
        $paginate = $request->query('n', 5);
        $templateModel = $this->getTemplateModel();
        //filtrando por nombre
        if($fetch = $request->input('fetch'))
        {
            $templateModel = $templateModel->where("template_name", 'like', '%'.$fetch.'%');
        }
        $template = $templateModel->select("id", "template_name", 'input_id', 'created_at')
            ->where("form_id", $formId)->paginate($paginate)->withQueryString();

        $template = $this->getiInputNames($template);
        return $template;
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \App\Models\Template  $template
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request)
    {

    }

    /**
     * João Beleño
     * 02-08-2021
     * Método para borrar el template
     */
    public function delete($templateId)
    {
        $templateModel = $this->getTemplateModel();
        $templateModel->destroy($templateId);
    }

    /**
     * João Beleño
     * 02-08-2021
     * Metodo para crear el template con las respuestas y el csv
     */
    public function buildTemplate(Request $request)
    {
        $formAnswer = '[{"id":531,"name_section":"Datos básicos del cliente","type_section":1,"fields":[{"id":1631031858291,"key":"firstName","cols":1,"type":"text","label":"Primer nombre","value":"Leonardo","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858292,"key":"middleName","cols":1,"type":"text","label":"Segundo nombre","value":"","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858293,"key":"lastName","cols":1,"type":"text","label":"Primer apellido","value":"Giraldo","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858294,"key":"secondLastName","cols":1,"type":"text","label":"Segundo apellido","value":"","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858296,"key":"document_type_id","cols":"2","type":"options","label":"Tipo de documento","value":1,"canAdd":false,"options":[{"id":1,"name":"Cédula de ciudadania"},{"id":2,"name":"Tarjeta de identidad"},{"id":3,"name":"NIT"},{"id":3,"name":"Cédula de extranjería"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":true,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858297,"key":"document","cols":1,"type":"text","label":"No. documento","value":"80190911","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858298,"key":"phone","cols":1,"type":"number","label":"Teléfono","value":"3506309016","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631031858299,"key":"email","cols":1,"type":"email","label":"Correo electrónico","value":"mail@gmail.com","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631040266488,"key":"fecha-de-nacimiento8","cols":"2","type":"date","label":"Fecha de Nacimiento","value":"2021-09-09T05:00:00.000Z","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"datepicker","dependencies":[],"see":true,"seeDepen":true},{"id":1631033379834,"key":"departamento9","cols":1,"type":"options","label":"Departamento","value":1,"canAdd":false,"options":[{"id":1,"name":"Test"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":true,"controlType":"autocomplete","dependencies":[],"see":true,"seeDepen":true},{"id":1631033415499,"key":"ciudad10","cols":1,"type":"options","label":"Ciudad","value":1,"canAdd":false,"options":[{"id":1,"name":"Test1"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"autocomplete","dependencies":[{"name":"Test","idField":1631033379834}],"see":true,"seeDepen":true},{"id":1631032877178,"key":"co-id11","cols":1,"type":"text","label":"Co id","value":"1","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631033001482,"key":"plan-vigente12","cols":1,"type":"text","label":"Plan vigente","value":"1","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631033204436,"key":"corte13","cols":1,"type":"date","label":"Corte","value":"2001-01-15T05:00:00.000Z","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":true,"controlType":"datepicker","dependencies":[],"see":true,"seeDepen":true},{"id":1631033224411,"key":"fecha-de-contrato14","cols":"2","type":"date","label":"Fecha de Contrato","value":"2021-09-09T05:00:00.000Z","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":true,"controlType":"datepicker","dependencies":[],"see":true,"seeDepen":true},{"id":1631033256595,"key":"numero-movil15","cols":1,"type":"number","label":"Número móvil","value":"3506309016","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631033294018,"key":"cfm16","cols":1,"type":"text","label":"CFM","value":"12345","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631033464292,"key":"tipo-de-alta17","cols":1,"type":"text","label":"Tipo de Alta","value":"12345","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631033499664,"key":"aplica-descuento-familiar18","cols":"2","type":"text","label":"Aplica Descuento Familiar","value":"No","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":true,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":532,"name_section":"GESTION APOYO","type_section":2,"fields":[{"id":1631039327920,"key":"producto-convergente0","cols":"2","type":"text","label":"Producto Convergente","value":"Producta Convergente","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631039606001,"key":"cantidad-creditos1","cols":"2","type":"number","label":"Cantidad Créditos","value":"12","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631039411997,"key":"equipo-financiado2","cols":"2","type":"text","label":"Equipo Financiado","value":"No","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true},{"id":1631039637497,"key":"cuota-fija3","cols":"2","type":"number","label":"Cuota Fija","value":"12,3457","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"currency","dependencies":[],"see":true,"seeDepen":true},{"id":1631039568611,"key":"saldo-a-financiar4","cols":"2","type":"number","label":"Saldo A Financiar","value":"1234","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"currency","dependencies":[],"see":true,"seeDepen":true},{"id":1631039664725,"key":"cantidad-cuotas5","cols":"2","type":"number","label":"Cantidad Cuotas","value":"2","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":533,"name_section":"ACTUALIZACIÓN DE DATOS","type_section":2,"fields":[{"id":1631039935849,"key":"el-nombre-esta-errado0","cols":"2","type":"options","label":"El Nombre esta Errado?","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040089925,"key":"el-documento-esta-errado1","cols":"2","type":"options","label":"El Documento esta Errado?","value":2,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040128003,"key":"se-actualiza-correo2","cols":"2","type":"options","label":"Se actualiza Correo?","value":2,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040161653,"key":"se-actualiza-direccion3","cols":"2","type":"options","label":"Se actualiza Dirección?","value":2,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040304290,"key":"se-actualiza-fecha-nacimiento4","cols":"2","type":"options","label":"Se actualiza fecha Nacimiento?","value":2,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040344243,"key":"persona-que-recibe-la-llamada5","cols":"2","type":"options","label":"Persona que recibe la llamada","value":2,"canAdd":false,"options":[{"id":1,"name":"Titular de la linea "},{"id":2,"name":"Tercero que utiliza la linea"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631040410438,"key":"nombre-del-tercero6","cols":1,"type":"text","label":"Nombre del Tercero","value":"1212","canAdd":false,"options":[{"id":1,"name":null}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[{"name":"Tercero que utiliza la linea","idField":1631040344243}],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":534,"name_section":"GESTIÓN DE LA LLAMADA","type_section":2,"fields":[{"id":1631051513030,"key":"consultas0","cols":1,"type":"options","label":"CONSULTAS","value":2,"canAdd":false,"options":[{"id":1,"name":"Información clara"},{"id":2,"name":"Consultas"},{"id":3,"name":"Inconformidades"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631051637667,"key":"condiciones-de-producto1","cols":"2","type":"options","label":"CONDICIONES DE PRODUCTO","value":"","canAdd":false,"options":[{"id":1,"name":"Cliente no realiza preguntas"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Información clara","idField":1631051513030}],"see":true,"seeDepen":false},{"id":1631051664081,"key":"condiciones-de-producto2","cols":"3","type":"options","label":"CONDICIONES DE PRODUCTO","value":2,"canAdd":false,"options":[{"id":1,"name":"Condiciones del plan"},{"id":2,"name":"Detalle de factura y/o valor a pagar"},{"id":3,"name":"Cupo de financiamiento"},{"id":4,"name":"Campañas o descuentos"},{"id":5,"name":"Servicios de hogar"},{"id":6,"name":"Como me registro en las apps (cv, cm, cd, fya, miclaro)"},{"id":7,"name":"Equipo financiado"},{"id":8,"name":"Fechas (fecha de corte, flp)"},{"id":9,"name":"Nuevo Modo de Marcación"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Consultas","idField":1631051513030}],"see":true,"seeDepen":true},{"id":1631051671555,"key":"condiciones-de-producto3","cols":"3","type":"options","label":"CONDICIONES DE PRODUCTO","value":"","canAdd":false,"options":[{"id":1,"name":"Información no coincide con la oferta"},{"id":2,"name":"Cobros de servicios adicionales"},{"id":3,"name":"Problemas en Portabilidad"},{"id":4,"name":"No se entregó la promoción, campaña  u oferta"},{"id":5,"name":"Intención de desactivación"},{"id":6,"name":"Fecha de nacimiento Errado"},{"id":7,"name":"Líneas sin cobro de primer CFM"},{"id":8,"name":"No contrató plan pospago"},{"id":9,"name":"Nombre Errado"},{"id":10,"name":"Inconvenientes de señal"},{"id":11,"name":"El plan era abierto/cerrado y se activo el contrario"},{"id":12,"name":"Líneas con bloqueo de SMS"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Inconformidades","idField":1631051513030}],"see":true,"seeDepen":false},{"id":1631052044019,"key":"subtipificación14","cols":"2","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Fechas del plan"},{"id":2,"name":"Cobertura"},{"id":3,"name":"Condiciones básicas del plan (datos)"},{"id":4,"name":"Información de Claro Música"},{"id":5,"name":"Información de Claro Video"},{"id":6,"name":"Información de Familia y Amigos"},{"id":7,"name":"Información de LDI"},{"id":8,"name":"CFM no coincide con la oferta"},{"id":9,"name":"Otros"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Información no coincide con la oferta","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052301486,"key":"subtipificación15","cols":"2","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"SMS, MMS"},{"id":2,"name":"CM, CV, F&A"},{"id":3,"name":"Mensajes de suscripción (trivias)"},{"id":4,"name":"Roaming"},{"id":5,"name":"LDI"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Cobros de servicios adicionales","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052405638,"key":"subtipificación16","cols":"3","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"No entregaron la SIM, se acercó a un CAV"},{"id":2,"name":"Demora en la entrega de la SIM CARD"},{"id":3,"name":"Activaron la SIM antes de la entrega"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Problemas en Portabilidad","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052505959,"key":"subtipificación17","cols":"3","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Cargo fijo mensual no coincide con la oferta"},{"id":2,"name":"No hubo claridad en la oferta"},{"id":3,"name":"Cobros servicios adicionales"},{"id":4,"name":"Condiciones del plan"},{"id":5,"name":"Demora en la activación "},{"id":6,"name":"Falta de información"},{"id":7,"name":"Inconvenientes con la activación y/o servicio"},{"id":8,"name":"Inconvenientes de señal en voz"},{"id":9,"name":"Inconvenientes de señal en datos"},{"id":10,"name":"Información errada"},{"id":11,"name":"Mejor oferta en otro operador"},{"id":12,"name":"Motivos económicos"},{"id":13,"name":"No se entrego la promoción, campaña, oferta"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Intención de desactivación","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052687951,"key":"subtipificación18","cols":1,"type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Se actualiza en AC"},{"id":2,"name":"No se actualiza (tercero)"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Fecha de nacimiento Errado","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052814436,"key":"subtipificación19","cols":"3","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Cliente se acerca a comprar equipo y le activan plan"},{"id":2,"name":"No acepta y aun así le activan"},{"id":3,"name":"Fraude/Me vendieron la sim en la calle"},{"id":4,"name":"Fraude/No conoce el titular"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"No contrató plan pospago","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052923412,"key":"departamentos10","cols":1,"type":"options","label":"Departamentos","value":"","canAdd":false,"options":[{"id":1,"name":"Test"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"autocomplete","dependencies":[{"name":"Inconvenientes de señal","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631053023979,"key":"ciudades11","cols":1,"type":"options","label":"Ciudades","value":"","canAdd":false,"options":[{"id":1,"name":"Test1"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"autocomplete","dependencies":[{"name":"Test","idField":1631052923412}],"see":true,"seeDepen":false},{"id":1631053310597,"key":"subtipificación112","cols":"3","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Se realiza el cambio de plan cerrado/abierto"},{"id":2,"name":"No se realiza el cambio de plan"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"El plan era abierto/cerrado y se activo el contrario","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631052978563,"key":"subtipificación113","cols":"3","type":"options","label":"Subtipificación1","value":"","canAdd":false,"options":[{"id":1,"name":"Equipo desactualizado"},{"id":2,"name":"Sim card desactualizada"},{"id":3,"name":"No hay cobertura 4g"},{"id":4,"name":"Sitios específicos oficina"},{"id":5,"name":"Sitios específicos hogar"},{"id":6,"name":"Sitios específicos en trasporte"},{"id":7,"name":"Sitios especifico en pueblos/vereda/finca"},{"id":8,"name":"Falla en todo sitio"}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":50,"minLength":1,"preloaded":false,"controlType":"dropdown","dependencies":[{"name":"Inconvenientes de señal","idField":1631051671555}],"see":true,"seeDepen":false},{"id":1631053236931,"key":"nombre-pueblo/vereda14","cols":"2","type":"text","label":"Nombre Pueblo/Vereda","value":"","canAdd":false,"options":[{"id":1,"name":null}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[{"name":"Sitios especifico en pueblos/vereda/finca","idField":1631052978563}],"see":true,"seeDepen":false},{"id":1631052245964,"key":"cuales15","cols":1,"type":"text","label":"Cuales","value":"","canAdd":false,"options":[{"id":1,"name":null}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[{"name":"Otros","idField":1631052044019}],"see":true,"seeDepen":false}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":535,"name_section":"GESTIONES ADICIONALES","type_section":2,"fields":[{"id":1631053375424,"key":"el-vendedor-le-acompañó-en-la-descarga-del-app-mi-claro0","cols":"3","type":"options","label":"El Vendedor le acompañó en la descarga del App Mi Claro","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053461506,"key":"se-hizo-cambio-de-plan-paralelo?1","cols":"2","type":"options","label":"Se hizo cambio de plan paralelo?","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053491181,"key":"se-activó-descuento-familiar?2","cols":"2","type":"options","label":"Se activó descuento familiar?","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053522266,"key":"envió-mensaje-mi-claro-app3","cols":"2","type":"options","label":"Envió Mensaje Mi Claro App","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053553030,"key":"envió-mensaje-claro-música4","cols":"2","type":"options","label":"Envió Mensaje Claro Música","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053592984,"key":"envió-mensaje-claro-video5","cols":"2","type":"options","label":"Envió Mensaje Claro Video","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053629252,"key":"envió-mensaje-fya6","cols":"2","type":"options","label":"Envió Mensaje FyA","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":536,"name_section":"COMO SE FIDELIZÓ AL CLIENTE","type_section":2,"fields":[{"id":1631053658874,"key":"como-se-fidelizó0","cols":"4","type":"options","label":"Como se fidelizó","value":1,"canAdd":false,"options":[{"id":1,"name":"Resaltar beneficios (Aclaración condiciones del plan, beneficios, valor agregado)"},{"id":2,"name":"Soporte de señal (configuración de línea en QDN, Conciliación línea, perfil sim card)\t"},{"id":3,"name":"Cambio de plan (Paralelo)\t"},{"id":4,"name":"Explicación detalle de facturación\t"},{"id":5,"name":"Registro y/o soporte de aplicaciones (Claro video /Claro música / Mi Claro / Familia y Amigos)"},{"id":6,"name":"Escalamiento interno"},{"id":7,"name":"Actualización de datos"},{"id":8,"name":"Activación Todo Claro"},{"id":9,"name":"Activación o desactivación de servicios suplementarios"},{"id":10,"name":"Activación Descuento Familiar"},{"id":11,"name":"Gestión factura (aclaración de conceptos facturados, fechas de pago, actualización de mail para factura electrónica"},{"id":12,"name":"Cambios de ciclo"},{"id":13,"name":"Condiciones de financiamiento equipo"},{"id":14,"name":"Ofrecimiento servicios Móvil-Hogar"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631053895386,"key":"observación1","cols":"2","type":"text","label":"Observación","value":"Pro0ductos","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true},{"id":537,"name_section":"MÓDULOS","type_section":2,"fields":[{"id":1631053934948,"key":"módulo-de-ventas0","cols":"2","type":"options","label":"Módulo de Ventas","value":1,"canAdd":false,"options":[{"id":1,"name":"Si"},{"id":2,"name":"No"}],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":true,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":null,"minLength":null,"preloaded":false,"controlType":"dropdown","dependencies":[],"see":true,"seeDepen":true},{"id":1631054016328,"key":"seguimiento1","cols":1,"type":"text","label":"Seguimiento","value":"1234","canAdd":false,"options":[{"id":1,"name":null}],"tooltip":{"have":false,"content":""},"disabled":true,"inReport":true,"isFather":false,"required":true,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[{"name":"Si","idField":1631053934948}],"see":true,"seeDepen":true},{"id":1631054064909,"key":"observación2","cols":"2","type":"text","label":"Observación","value":"1234","canAdd":false,"options":[],"tooltip":{"have":false,"content":""},"disabled":false,"inReport":true,"isFather":false,"required":false,"seeRoles":["admin","asesor","supervisor_crm"],"editRoles":["admin","asesor","supervisor_crm"],"maxLength":500,"minLength":1,"preloaded":false,"controlType":"textbox","dependencies":[],"see":true,"seeDepen":true}],"collapse":0,"duplicate":0,"state":0,"see":true}]';
        $csv = [];
        $plantilla = array();
        $templateModel = $this->getTemplateModel();
        $template = $templateModel->findOrFail($request->template_id);
        $formAnswer = json_decode($formAnswer, true);
        $valueDelimiter = is_numeric($template->value_delimiter)  ? chr($template->value_delimiter) : "";
        $inputsId = json_decode($template->input_id, true);
        foreach ($inputsId as $key => $inputId)
        {
            foreach($formAnswer as $section)
            {
                foreach($section['fields'] as $field)
                {
                    $csvValue='';
                    if((is_array($inputId["id"]) && in_array($field['id'], $inputId["id"])) || $inputId["id"] == $field['id'])
                    {
                        if($field["type"] == "options")
                        {
                            foreach ($field["options"] as $option)
                            {
                                if($option['id'] == $field["value"])
                                {
                                    $field["value"] = $option['name'];
                                }
                            }
                        }
                        $fieldTemplate = $inputId;
                        $registerDelimiter = is_numeric($fieldTemplate["registerDelimiter"]) ? chr($fieldTemplate["registerDelimiter"]) : "";
                        $csvValue.= $registerDelimiter;
                        if($fieldTemplate["haveTheLabel"])
                        {
                            $csvValue.= $field["label"].":";
                        }
                        $csvValue.= $field["value"].$registerDelimiter;
                        \Log::info($key);
                        if(!isset($plantilla[$key]['value'])){
                            $plantilla[$key]= $field;
                            $csv[$key]=$csvValue;
                        }else if($plantilla[$key]['value']==''){
                            $plantilla[$key]= $field;
                            $csv[$key]=$csvValue;
                        }
                    }
                }
            }
        }
        \Log::info(gettype($plantilla));
        $data = [];
        $data['csv'] = implode($valueDelimiter,$csv).$valueDelimiter;
        $data['plantilla'] = $plantilla;
        $data['fields_writable'] = $template->fields_writable;
        $data['value_delimiter'] = $template->value_delimiter;
        return $data;
    }
}
